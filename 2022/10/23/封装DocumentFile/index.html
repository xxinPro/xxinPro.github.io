<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.jpg"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.ico"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.ico"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="INib61UyYabZlsc0LPzbi5O2qlux9S7YlcvrRdmFOmU"><meta name="msvalidate.01" content="A117C8AE0DF96AAEC2BC9D4914C0B404"><meta name="yandex-verification" content="2c7e88b2e774befb"><meta name="baidu-site-verification" content="codeva-Hhmgc2znuV"><meta name="360-site-verification" content="99dc35dba24d3316a5c4165a21d1c8b2"><meta name="sogou_site_verification" content="n0MrA7DawS"><meta name="bytedance-verification-code" content="T5+8Lbmr5HPdlA87vM/H"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"blog.xxin.xyz","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.12.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js"></script><meta name="description" content="使用SAF框架读写Android&#x2F;data目录、外置TF卡目录"><meta property="og:type" content="article"><meta property="og:title" content="封装DocumentFile"><meta property="og:url" content="https://blog.xxin.xyz/2022/10/23/%E5%B0%81%E8%A3%85DocumentFile/index.html"><meta property="og:site_name" content="小信笔记"><meta property="og:description" content="使用SAF框架读写Android&#x2F;data目录、外置TF卡目录"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://img.xxin.xyz/img/admin/2022/10/23/114n1i8.jpg"><meta property="article:published_time" content="2022-10-23T10:48:16.000Z"><meta property="article:modified_time" content="2024-01-30T13:21:14.988Z"><meta property="article:author" content="xxin"><meta property="article:tag" content="Android开发手记"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://img.xxin.xyz/img/admin/2022/10/23/114n1i8.jpg"><link rel="canonical" href="https://blog.xxin.xyz/2022/10/23/%E5%B0%81%E8%A3%85DocumentFile/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.xxin.xyz/2022/10/23/%E5%B0%81%E8%A3%85DocumentFile/","path":"2022/10/23/封装DocumentFile/","title":"封装DocumentFile"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>封装DocumentFile | 小信笔记</title><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">小信笔记</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">逃避思考，热爱幻想</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%8C%83%E5%9B%B4"><span class="nav-number">1.</span> <span class="nav-text">使用范围</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E6%9D%83%E9%99%90"><span class="nav-number">2.</span> <span class="nav-text">添加权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DocumentFileUtils"><span class="nav-number">3.</span> <span class="nav-text">DocumentFileUtils</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E9%87%8F"><span class="nav-number">3.1.</span> <span class="nav-text">常量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%92%8C%E7%A7%BB%E9%99%A4%E6%96%9C%E6%9D%A0"><span class="nav-number">3.2.</span> <span class="nav-text">添加和移除斜杠</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%86%E7%9B%AE%E5%BD%95%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2%E4%B8%BAUri%E5%9C%B0%E5%9D%80"><span class="nav-number">3.3.</span> <span class="nav-text">将目录地址转换为Uri地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%99%E6%9E%84%E9%80%A0%E5%99%A8"><span class="nav-number">3.4.</span> <span class="nav-text">写构造器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E5%88%A4%E6%96%AD"><span class="nav-number">3.5.</span> <span class="nav-text">权限判断</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%B3%E8%AF%B7%E6%9D%83%E9%99%90"><span class="nav-number">3.6.</span> <span class="nav-text">申请权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96DocumentFile%E5%AF%B9%E8%B1%A1"><span class="nav-number">3.7.</span> <span class="nav-text">获取DocumentFile对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E3%80%81%E5%88%A0%E9%99%A4%E3%80%81%E9%87%8D%E5%91%BD%E5%90%8D"><span class="nav-number">3.8.</span> <span class="nav-text">创建、删除、重命名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%A4%8D%E5%88%B6"><span class="nav-number">3.9.</span> <span class="nav-text">文件复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%B5%81"><span class="nav-number">3.10.</span> <span class="nav-text">获取流</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E"><span class="nav-number">4.</span> <span class="nav-text">使用说明</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="xxin" src="https://q1.qlogo.cn/g?b=qq&nk=3033528136&s=640"><p class="site-author-name" itemprop="name">xxin</p><div class="site-description" itemprop="description">路漫漫其修远兮，吾将上下而求索。</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">175</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">23</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/xxinPro" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xxinPro" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://wpa.qq.com/msgrd?v=3&uin=3033528136&site=qq&menu=yes" title="QQ → https:&#x2F;&#x2F;wpa.qq.com&#x2F;msgrd?v&#x3D;3&amp;uin&#x3D;3033528136&amp;site&#x3D;qq&amp;menu&#x3D;yes" rel="noopener" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a> </span><span class="links-of-author-item"><a href="mailto:x@xxin.xyz" title="E-Mail → mailto:x@xxin.xyz" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a></span></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.xxin.xyz/2022/10/23/%E5%B0%81%E8%A3%85DocumentFile/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://q1.qlogo.cn/g?b=qq&nk=3033528136&s=640"><meta itemprop="name" content="xxin"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="小信笔记"><meta itemprop="description" content="路漫漫其修远兮，吾将上下而求索。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="封装DocumentFile | 小信笔记"><meta itemprop="description" content="<center>使用SAF框架读写Android/data目录、外置TF卡目录</center>"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">封装DocumentFile</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-10-23 18:48:16" itemprop="dateCreated datePublished" datetime="2022-10-23T18:48:16+08:00">2022-10-23</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a> </span></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="fa fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>16k</span></span></div><div class="post-description"><center>使用SAF框架读写Android/data目录、外置TF卡目录</center></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="使用范围"><a href="#使用范围" class="headerlink" title="使用范围"></a>使用范围</h2><p>&ensp;&ensp;使用文中方式封装的<code>DocumentFile</code>工具类适用范围极为广阔，不仅可以操作Android10-Android13(目前最新版)的<code>Android/data</code>目录，还可以操作外置TF卡中的文件，以及手机外接U盘中的文件，理论支持一切连接手机的外部储存硬件</p><h2 id="添加权限"><a href="#添加权限" class="headerlink" title="添加权限"></a>添加权限</h2><p>&ensp;&ensp;读取和写入外部储存不需要多说，所有文件访问权限好像是能提升SAF框架的读写速度</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 读取外部储存 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 写入外部储存 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 所有文件访问权限 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.MANAGE_EXTERNAL_STORAGE&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><h2 id="DocumentFileUtils"><a href="#DocumentFileUtils" class="headerlink" title="DocumentFileUtils"></a>DocumentFileUtils</h2><p>&ensp;&ensp;新建一个DocumentFileUtils类，使用这个类来对DocumentFile进行读写操作</p><h3 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h3><p>&ensp;&ensp;所需的一些常量</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Context context;          <span class="comment">// 上下文</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String URI_HEAD;          <span class="comment">// uri地址头，任何一个DocumentFile的Uri地址都包含这个地址头</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String permissionPath;    <span class="comment">// 请求权限的目录地址（如：storage/sdcard/test）</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String permissionUriStr;  <span class="comment">// 请求权限的目录的uri地址（该Uri地址仅用于申请权限，切勿直接操作）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String PRIMARY_STORAGE;     <span class="comment">// 主储存目录:   /storage/emulated/0</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String ANDROID_PATH;        <span class="comment">// Android目录: /storage/emulated/0/Android</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String ANDROID_DATA_PATH;   <span class="comment">// data目录:    /storage/emulated/0/Android/data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String ANDROID_OBB_PATH;    <span class="comment">// obb目录:     /storage/emulated/0/Android/obb</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    URI_HEAD = <span class="string">&quot;content://com.android.externalstorage.documents/tree/&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="comment">// 一般来说主储存目录是/storage/emulated/0</span></span><br><span class="line">    PRIMARY_STORAGE = Environment.getExternalStorageDirectory().getAbsolutePath();</span><br><span class="line">    ANDROID_PATH = PRIMARY_STORAGE + <span class="string">&quot;/Android&quot;</span>;</span><br><span class="line">    ANDROID_DATA_PATH = ANDROID_PATH + <span class="string">&quot;/data&quot;</span>;</span><br><span class="line">    ANDROID_OBB_PATH = ANDROID_PATH + <span class="string">&quot;/obb&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="添加和移除斜杠"><a href="#添加和移除斜杠" class="headerlink" title="添加和移除斜杠"></a>添加和移除斜杠</h3><p>&ensp;&ensp;然后为了防止传入的目录绝对正确，我们要先对目录的前后添加斜杠“/”，在后续的操作中会用到移除</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在地址头和地址尾添加斜线</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> permissionDir 请求权限的目录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">addSlash</span><span class="params">(String permissionDir)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!permissionDir.startsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">        permissionDir = <span class="string">&quot;/&quot;</span> + permissionDir;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!permissionDir.endsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">        permissionDir = permissionDir + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> permissionDir;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 移除地址头和地址尾的斜杠</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> path 文件地址</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">removeSlash</span><span class="params">(String path)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (path.startsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">        path = path.substring(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (path.endsWith(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">        path = path.substring(<span class="number">0</span>, path.length() - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="将目录地址转换为Uri地址"><a href="#将目录地址转换为Uri地址" class="headerlink" title="将目录地址转换为Uri地址"></a>将目录地址转换为Uri地址</h3><p>&ensp;&ensp;再将目录地址转换为Uri地址</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将目录地址转换为uri地址，此处要求绝对正确的完整的目录地址</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 转换后的Uri地址仅申请权限时可用，不可以直接使用该Uri地址转换为DocumentFile</span></span><br><span class="line"><span class="comment"> * 注：储存器（外置TF卡、内置SD卡都称为储存器）根目录除外</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> path 文件路径，注意一定要传入文件的完整的绝对路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 格式化后的Uri地址字符串</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">pathToUri</span><span class="params">(String path)</span> &#123;</span><br><span class="line">    <span class="comment">// 在头尾添加斜杠</span></span><br><span class="line">    path = addSlash(path);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义路径头规范，一般路径头是/storage/</span></span><br><span class="line">    <span class="comment">// 例1：/storage/6238-3332/               =&gt; /storage/</span></span><br><span class="line">    <span class="comment">// 例2：/storage/6238-3332/Android/       =&gt; /storage/</span></span><br><span class="line">    <span class="comment">// 例3：/storage/emulated/0/Android/data/ =&gt; /storage/</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">pathHead</span> <span class="operator">=</span> PRIMARY_STORAGE.substring(<span class="number">0</span>, PRIMARY_STORAGE.indexOf(<span class="string">&quot;/&quot;</span>, <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 如果传入的路径头与规范头不同，说明路径不对</span></span><br><span class="line">    <span class="keyword">if</span> (!path.startsWith(pathHead)) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这一步去除路径头，假设规范路径头是/storage/</span></span><br><span class="line">    <span class="comment">// 例1：/storage/6238-3332/               =&gt; 6238-3332/</span></span><br><span class="line">    <span class="comment">// 例2：/storage/6238-3332/Android/       =&gt; 6238-3332/Android/</span></span><br><span class="line">    <span class="comment">// 例3：/storage/emulated/0/Android/data/ =&gt; emulated/0/Android/data/</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">pathContent</span> <span class="operator">=</span> path.substring(pathHead.length());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取/storage/下的主储存目录，一般主储存目录是emulated/0，不需要考虑路径头不属于主储存目录的情况</span></span><br><span class="line">    <span class="comment">// 例1：/storage/emulated/0 =&gt; emulated/0</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">primaryPath</span> <span class="operator">=</span> PRIMARY_STORAGE.substring(pathHead.length());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果传入的目录是Android内置SD卡下的主目录，假设主目录是emulated/0，将传入路径中的emulated/0替换为primary</span></span><br><span class="line">    <span class="comment">// 例1：emulated/0/Android/data/ =&gt; primary/Android/data/</span></span><br><span class="line">    <span class="keyword">if</span> (pathContent.startsWith(primaryPath))</span><br><span class="line">        pathContent = <span class="string">&quot;primary&quot;</span> + pathContent.substring(primaryPath.length());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拿到储存器目录的目录名</span></span><br><span class="line">    <span class="comment">// 理论上讲，所传入的目录路径中，/storage/的直接子目录就是储存器（外置TF卡、内置SD卡都称为储存器）目录的目录名</span></span><br><span class="line">    <span class="comment">// 例1：6238-3332/            =&gt; 6238-3332</span></span><br><span class="line">    <span class="comment">// 例2：6238-3332/Android/    =&gt; 6238-3332</span></span><br><span class="line">    <span class="comment">// 例3：primary/Android/data/ =&gt; primary</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">rootPathName</span> <span class="operator">=</span> pathContent.substring(<span class="number">0</span>, pathContent.indexOf(<span class="string">&quot;/&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从路径中剔除储存器目录</span></span><br><span class="line">    <span class="comment">// 例1：6238-3332/            =&gt; /</span></span><br><span class="line">    <span class="comment">// 例2：6238-3332/Android/    =&gt; Android/</span></span><br><span class="line">    <span class="comment">// 例3：primary/Android/data/ =&gt; Android/data/</span></span><br><span class="line">    pathContent = pathContent.substring(rootPathName.length() + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 去除末尾的“/”</span></span><br><span class="line">    <span class="comment">// 例1：/             =&gt;</span></span><br><span class="line">    <span class="comment">// 例2：Android/      =&gt; Android</span></span><br><span class="line">    <span class="comment">// 例3：Android/data/ =&gt; Android/data</span></span><br><span class="line">    <span class="keyword">if</span> (pathContent.endsWith(<span class="string">&quot;/&quot;</span>))</span><br><span class="line">        pathContent = pathContent.substring(<span class="number">0</span>, pathContent.length() - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将目录路径中的/全部替换为%2F</span></span><br><span class="line">    <span class="comment">// 例1：              =&gt;</span></span><br><span class="line">    <span class="comment">// 例2：Android       =&gt; Android</span></span><br><span class="line">    <span class="comment">// 例2：Android/data  =&gt; Android%2Fdata</span></span><br><span class="line">    pathContent = pathContent.replaceAll(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;%2F&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 得到完整Uri地址</span></span><br><span class="line">    <span class="keyword">return</span> URI_HEAD + rootPathName + <span class="string">&quot;%3A&quot;</span> + pathContent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="写构造器"><a href="#写构造器" class="headerlink" title="写构造器"></a>写构造器</h3><p>&ensp;&ensp;在构造器中要得到请求权限的目录地址、请求权限的目录的uri地址、上下文，请求码可以暂时不传<br>&ensp;&ensp;1. Context context: 上下文<br>&ensp;&ensp;2. String permissionDir: 需要请求权限的目录，下文中称为“权限目录”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> context       上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> permissionDir 请求权限的目录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> DocumentFileUtils <span class="title function_">create</span><span class="params">(Context context, String permissionDir)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">XAFUtil</span>(context, permissionDir);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> context       上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> permissionDir 请求权限的目录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">DocumentFileUtils</span><span class="params">(Context context, String permissionDir)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.permissionPath = addSlash(permissionDir);</span><br><span class="line">    <span class="built_in">this</span>.permissionUriStr = pathToUri(permissionDir);</span><br><span class="line">    <span class="built_in">this</span>.context = context;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 错误时提示</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.permissionUriStr == <span class="literal">null</span>)</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;DocumentFileUtils: root directory permissionDir field&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="权限判断"><a href="#权限判断" class="headerlink" title="权限判断"></a>权限判断</h3><p>&ensp;&ensp;判断权限目录是否拥有访问权限</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 权限目录是否拥有访问权限</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isPermission</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (permissionUriStr == <span class="literal">null</span>) Log.e(TAG, <span class="string">&quot;isPermission: root directory path field&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Uri</span> <span class="variable">uriPath</span> <span class="operator">=</span> Uri.parse(permissionUriStr);</span><br><span class="line"></span><br><span class="line">    <span class="type">DocumentFile</span> <span class="variable">documentFile</span> <span class="operator">=</span> DocumentFile.fromTreeUri(<span class="built_in">this</span>.context, uriPath);</span><br><span class="line">    <span class="keyword">if</span> (documentFile != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> documentFile.canWrite();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&ensp;&ensp;判断是否拥有所有文件访问权限，我个人感觉这是一个很操蛋的名字，既然叫所有文件访问权限，我们拥有这个权限之后又不能访问所有文件，例如Android/data</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 是否拥有所有文件访问权限，安卓11之前无需申请</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isManagerExternalPermission</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.R) &#123;</span><br><span class="line">        <span class="keyword">return</span> Environment.isExternalStorageManager();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="申请权限"><a href="#申请权限" class="headerlink" title="申请权限"></a>申请权限</h3><p>&ensp;&ensp;申请权限目录的访问权限<br>&ensp;&ensp;这里注意一个困扰了我很久的细节问题，app的gradle文件中的最大sdk尽量不要超过29，从30开始将无法获得某些目录的权限例如<code>storage/emulated/0</code>和<code>storage/emulated/0/Android</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求所传入目录的访问权限</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> activity    调用的activity</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> requestCode 请求码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestPermission</span><span class="params">(Activity activity, <span class="type">int</span> requestCode)</span> &#123;</span><br><span class="line">    requestPermission(activity, <span class="literal">null</span>, requestCode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求所传入目录的访问权限</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fragment    调用的fragment</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> requestCode 请求码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestPermission</span><span class="params">(Fragment fragment, <span class="type">int</span> requestCode)</span> &#123;</span><br><span class="line">    requestPermission(<span class="literal">null</span>, fragment, requestCode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">requestPermission</span><span class="params">(Activity activity, Fragment fragment, <span class="type">int</span> requestCode)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (permissionUriStr == <span class="literal">null</span>) &#123; <span class="comment">// 请求权限的目录的uri地址错误</span></span><br><span class="line">        Log.e(TAG, <span class="string">&quot;requestPermission: permission directory path field&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.O) &#123; <span class="comment">// 系统版本过低</span></span><br><span class="line">        Log.e(TAG, <span class="string">&quot;requestPermission: sdk version too low&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求码</span></span><br><span class="line">    <span class="built_in">this</span>.requestCode = requestCode;</span><br><span class="line">    <span class="comment">// 将请求权限的目录的uri地址转换为Uri对象</span></span><br><span class="line">    <span class="type">Uri</span> <span class="variable">uriPath</span> <span class="operator">=</span> Uri.parse(permissionUriStr);</span><br><span class="line">    <span class="comment">// 通过Uri对象得到DocumentFile对象，该对象只能在申请权限时使用，不可以直接读写，权限目录除外</span></span><br><span class="line">    <span class="type">DocumentFile</span> <span class="variable">documentFile</span> <span class="operator">=</span> DocumentFile.fromTreeUri(<span class="built_in">this</span>.context, uriPath);</span><br><span class="line">    <span class="keyword">if</span> (documentFile != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> createIntent(documentFile);</span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="literal">null</span>) &#123;</span><br><span class="line">            activity.startActivityForResult(intent, requestCode);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            fragment.startActivityForResult(intent, requestCode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;requestPermission: &quot;</span> + permissionUriStr + <span class="string">&quot; not exists&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequiresApi(api = Build.VERSION_CODES.O)</span></span><br><span class="line"><span class="keyword">private</span> Intent <span class="title function_">createIntent</span><span class="params">(DocumentFile documentFile)</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_OPEN_DOCUMENT_TREE);</span><br><span class="line">    intent.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION</span><br><span class="line">            | Intent.FLAG_GRANT_WRITE_URI_PERMISSION</span><br><span class="line">            | Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION</span><br><span class="line">            | Intent.FLAG_GRANT_PREFIX_URI_PERMISSION);</span><br><span class="line">    intent.putExtra(DocumentsContract.EXTRA_INITIAL_URI, documentFile.getUri());</span><br><span class="line">    <span class="keyword">return</span> intent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&ensp;&ensp;申请权限之后需要进行保存权限</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求权限后，在onActivityResult中调用保存</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> requestCode 请求码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> intent      请求数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressLint(&quot;WrongConstant&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">savePermission</span><span class="params">(<span class="type">int</span> requestCode, Intent intent)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (intent == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.requestCode == requestCode) &#123;</span><br><span class="line">        <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> intent.getData();</span><br><span class="line">        <span class="keyword">if</span> (uri != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">DocumentFile</span> <span class="variable">documentFile</span> <span class="operator">=</span> DocumentFile.fromTreeUri(context, uri);</span><br><span class="line">            <span class="keyword">if</span> (documentFile != <span class="literal">null</span> &amp;&amp; documentFile.canWrite()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.context.getContentResolver().takePersistableUriPermission(uri,</span><br><span class="line">                            intent.getFlags() &amp; (Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">&quot;savePermission: sdk version too low&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;savePermission: no write permission&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;savePermission: data uri field&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;savePermission: requestCode field&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&ensp;&ensp;请求所有文件访问权限</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 申请所有文件访问权限，安卓11之前无需申请</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> activity    上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> requestCode 请求权限请求码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressLint(&quot;InlinedApi&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestManagerExternalPermission</span><span class="params">(Activity activity, <span class="type">int</span> requestCode)</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Settings.ACTION_MANAGE_APP_ALL_FILES_ACCESS_PERMISSION);</span><br><span class="line">    intent.setData(Uri.parse(<span class="string">&quot;package:&quot;</span> + activity.getPackageName()));</span><br><span class="line">    activity.startActivityForResult(intent, requestCode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取DocumentFile对象"><a href="#获取DocumentFile对象" class="headerlink" title="获取DocumentFile对象"></a>获取DocumentFile对象</h3><p>&ensp;&ensp;获取某文件DocumentFile对象<br>&ensp;&ensp;在这一步操作中，首先在传入地址的头尾添加斜杠，不管它是文件或文件夹<br>&ensp;&ensp;然后将传入的路径转换为Uri地址，当Uri地址错误，或者Uri地址不属于权限目录的Uri地址时返回null<br>&ensp;&ensp;如果传入的目录是权限目录直接return出去就好，如果是其子文件或子目录，则需要进行剔除相同部分，然后根据其不同的类型得到不同的DocumentFile</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取某文件或者目录的DocumentFile对象</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filePath 目录或者文件路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> isFile   目标是否是文件类型，如果是文件夹类型则传入false</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> DocumentFile对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> DocumentFile <span class="title function_">getDocumentFile</span><span class="params">(String filePath, <span class="type">boolean</span> isFile)</span> &#123;</span><br><span class="line">    <span class="comment">// 在地址头和地址尾添加斜杠</span></span><br><span class="line">    filePath = addSlash(filePath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将文件路径转换为uri地址</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">_uriPathStr</span> <span class="operator">=</span> pathToUriStr(filePath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 文件uri地址为空或者文件不属于权限目录时</span></span><br><span class="line">    <span class="keyword">if</span> (_uriPathStr == <span class="literal">null</span> || !_uriPathStr.startsWith(permissionUriStr)) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 权限目录DocumentFile对象</span></span><br><span class="line">    <span class="type">DocumentFile</span> <span class="variable">documentFile</span> <span class="operator">=</span> DocumentFile.fromTreeUri(context, Uri.parse(permissionUriStr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// uri地址与权限目录的uri地址相同时，直接把权限目录的DocumentFile对象return出去</span></span><br><span class="line">    <span class="keyword">if</span> (_uriPathStr.equals(permissionUriStr)) <span class="keyword">return</span> documentFile;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 去除与权限目录一样的部分，仅保留权限目录下的文件或文件夹路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">pathContent</span> <span class="operator">=</span> filePath.substring(<span class="built_in">this</span>.permissionPath.length());</span><br><span class="line">    <span class="keyword">return</span> getDocumentFile(documentFile, pathContent, isFile);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取目录DocumentFile对象下的目录或文件的DocumentFile对象，在搞懂这个方法前慎用</span></span><br><span class="line"><span class="comment"> * 例：传入/storage/sdCard/的DocumentFile和/test/1.txt，那就是获取/storage/sdCard/test/1.txt的DocumentFile对象</span></span><br><span class="line"><span class="comment"> * 注意，当路径中的文件或者文件夹不存在时，该方法会自动创建</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> documentFile DocumentFile对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filePath     DocumentFile对象下的目录或文件路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> isFile       路径是否是文件类型，如果是文件夹类型则传入false，反之true</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> DocumentFile <span class="title function_">getDocumentFile</span><span class="params">(DocumentFile documentFile, String filePath, <span class="type">boolean</span> isFile)</span> &#123;</span><br><span class="line">    <span class="comment">// 如果documentFile有问题</span></span><br><span class="line">    <span class="keyword">if</span> (documentFile == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 移除头尾的斜杠</span></span><br><span class="line">    filePath = removeSlash(filePath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果路径是空的</span></span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(filePath)) <span class="keyword">return</span> documentFile;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据层级分隔符，将路径分开</span></span><br><span class="line">    String[] pathArr = filePath.split(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"></span><br><span class="line">    DocumentFile[] documentFiles = documentFile.listFiles();</span><br><span class="line">    <span class="comment">// 路径完整的情况下</span></span><br><span class="line">    <span class="keyword">if</span> (pathArr.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 从路径中去除掉pathArr[0]</span></span><br><span class="line">        filePath = filePath.substring(pathArr[<span class="number">0</span>].length());</span><br><span class="line">        <span class="keyword">for</span> (DocumentFile _documentFile : documentFiles) &#123;</span><br><span class="line">            <span class="keyword">if</span> (_documentFile.getName() != <span class="literal">null</span> &amp;&amp; _documentFile.getName().equals(pathArr[<span class="number">0</span>])) &#123;</span><br><span class="line">                <span class="keyword">return</span> getDocumentFile(_documentFile, filePath, isFile);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 代码执行到这里表明文件夹中不存在指定的下一级文件夹/文件，需要我们创建一个</span></span><br><span class="line">        <span class="comment">// 如果pathArr.length为1，说明只剩下最后一个文件夹或文件没有找到，反之则一定为文件夹，创建文件夹即可</span></span><br><span class="line">        <span class="comment">// 如果指定的目标类型为文件，则创建文件，反之创建文件夹</span></span><br><span class="line">        <span class="keyword">if</span> (pathArr.length == <span class="number">1</span> &amp;&amp; isFile) &#123;</span><br><span class="line">            <span class="keyword">return</span> documentFile.createFile(<span class="string">&quot;&quot;</span>, pathArr[<span class="number">0</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">DocumentFile</span> <span class="variable">createDir</span> <span class="operator">=</span> documentFile.createDirectory(pathArr[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> getDocumentFile(createDir, filePath, isFile);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> documentFile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="创建、删除、重命名"><a href="#创建、删除、重命名" class="headerlink" title="创建、删除、重命名"></a>创建、删除、重命名</h3><p>&ensp;&ensp;文件和文件夹的创建、删除、重命名</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建文件夹</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> folderPath 文件夹路径</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> DocumentFile <span class="title function_">createDirectory</span><span class="params">(String folderPath)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getDocumentFile(folderPath, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建文件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filePath 文件路径</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> DocumentFile <span class="title function_">createFile</span><span class="params">(String filePath)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getDocumentFile(filePath, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除文件或文件夹</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filePath 文件/文件夹路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> isFile   是否是文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 删除结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteFile</span><span class="params">(String filePath, <span class="type">boolean</span> isFile)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getDocumentFile(filePath, isFile).delete();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文件、文件夹重命名</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filePath 文件/文件夹路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> isFile   是否是文件类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> newName  新文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 重命名结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">renameFile</span><span class="params">(String filePath, <span class="type">boolean</span> isFile, String newName)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getDocumentFile(filePath, isFile).renameTo(newName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="文件复制"><a href="#文件复制" class="headerlink" title="文件复制"></a>文件复制</h3><p>&ensp;&ensp;文件复制有三种方式：File复制到DocumentFile，DocumentFile复制到File，DocumentFile复制到DocumentFile</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将DocumentFile文件复制到File</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fromFile 源文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> toFile   目标文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">copyFile</span><span class="params">(DocumentFile fromFile, File toFile)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> context.getContentResolver().openInputStream(fromFile.getUri());</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(toFile);</span><br><span class="line">        copy(inputStream, fileOutputStream);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将File复制到DocumentFile</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fromFile 源文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> toFile   目标文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">copyFile</span><span class="params">(File fromFile, DocumentFile toFile)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(fromFile);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> context.getContentResolver().openOutputStream(toFile.getUri());</span><br><span class="line">        copy(fileInputStream, outputStream);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将DocumentFile到DocumentFile</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fromFile 源文件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> toFile   目标文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">copyFile</span><span class="params">(DocumentFile fromFile, DocumentFile toFile)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> context.getContentResolver().openInputStream(fromFile.getUri());</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> context.getContentResolver().openOutputStream(toFile.getUri());</span><br><span class="line">        copy(inputStream, outputStream);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 写入数据</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> inputStream  输入流</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> outputStream 输出流</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">copy</span><span class="params">(InputStream inputStream, OutputStream outputStream)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">int</span> len;</span><br><span class="line">        <span class="keyword">while</span> ((len = inputStream.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            outputStream.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (inputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                inputStream.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (outputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                outputStream.flush();</span><br><span class="line">                outputStream.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取流"><a href="#获取流" class="headerlink" title="获取流"></a>获取流</h3><p>&ensp;&ensp;ParcelFileDescriptor用于在某些场景中直接向DocumentFile中写入</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取输入流</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filePath 文件地址</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> InputStream <span class="title function_">getInputStream</span><span class="params">(String filePath)</span> &#123;</span><br><span class="line">    <span class="type">DocumentFile</span> <span class="variable">documentFile</span> <span class="operator">=</span> getDocumentFile(filePath, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> getInputStream(documentFile);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取输入流</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> documentFile 文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> InputStream <span class="title function_">getInputStream</span><span class="params">(DocumentFile documentFile)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> context.getContentResolver().openInputStream(documentFile.getUri());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 打开输出流</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> filePath 文件路径</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> OutputStream <span class="title function_">getOutputStream</span><span class="params">(String filePath)</span> &#123;</span><br><span class="line">    <span class="type">DocumentFile</span> <span class="variable">documentFile</span> <span class="operator">=</span> getDocumentFile(filePath, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> getOutputStream(documentFile);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 打开输出流</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> documentFile 文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> OutputStream <span class="title function_">getOutputStream</span><span class="params">(DocumentFile documentFile)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> context.getContentResolver().openOutputStream(documentFile.getUri());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取DocumentFile类型的文件描述</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> documentFile 文件的DocumentFile对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> openMode     打开文件的模式，一般情况下w是写模式，r是读模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> ParcelFileDescriptor <span class="title function_">getFileDescriptor</span><span class="params">(DocumentFile documentFile, String openMode)</span> &#123;</span><br><span class="line">    <span class="type">Uri</span> <span class="variable">uri</span> <span class="operator">=</span> documentFile.getUri();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 以写模式打开</span></span><br><span class="line">        <span class="keyword">return</span> context.getContentResolver().openFileDescriptor(uri, openMode);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h2><p>&ensp;&ensp;基础功能实现大体如下，注意调试时顶部的目录地址确定后，调试期间一定不要随意改动，因为很有可能改动后的目录地址没有申请权限，申请权限后点击按钮即可展示效果<br>&ensp;&ensp;DocumentFileUtils类由于没有对Uri写死，所以可以进行任何DocumentFile操作，例如Android/data目录，外置TF卡，SD卡等</p><p><img src="https://img.xxin.xyz/img/admin/2022/10/23/114n1i8.jpg" style="zoom:30%"></p><p>参考：<a target="_blank" rel="noopener" href="https://developer.android.google.cn/training/data-storage/shared/documents-files?hl=zh-cn">从共享存储空间访问文档和其他文件</a><br>开源地址：<a target="_blank" rel="noopener" href="https://github.com/xxinPro/XAFUtil">https://github.com/xxinPro/XAFUtil</a></p></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Android%E5%BC%80%E5%8F%91%E6%89%8B%E8%AE%B0/" rel="tag"><i class="fa fa-tag"></i> Android开发手记</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2022/10/17/eclipse%E6%90%AD%E5%BB%BAAndroid%E7%8E%AF%E5%A2%83/" rel="prev" title="eclipse搭建Android环境"><i class="fa fa-chevron-left"></i> eclipse搭建Android环境</a></div><div class="post-nav-item"><a href="/2022/10/26/%E5%90%91Android%E5%A4%96%E7%BD%AETF%E5%8D%A1%E4%B8%AD%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE/" rel="next" title="向Android外置TF卡中写入数据">向Android外置TF卡中写入数据 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备19064654号-5</a></div><div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">xxin</span></div></div></footer><script src="https://lib.baomitu.com/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script><script src="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="https://lib.baomitu.com/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script src="/js/third-party/fancybox.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/js/third-party/math/mathjax.js"></script></body></html>