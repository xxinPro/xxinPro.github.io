<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.jpg"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.ico"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.ico"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="INib61UyYabZlsc0LPzbi5O2qlux9S7YlcvrRdmFOmU"><meta name="msvalidate.01" content="A117C8AE0DF96AAEC2BC9D4914C0B404"><meta name="yandex-verification" content="2c7e88b2e774befb"><meta name="baidu-site-verification" content="codeva-Hhmgc2znuV"><meta name="360-site-verification" content="99dc35dba24d3316a5c4165a21d1c8b2"><meta name="sogou_site_verification" content="n0MrA7DawS"><meta name="bytedance-verification-code" content="T5+8Lbmr5HPdlA87vM/H"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://lib.baomitu.com/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"blog.xxin.xyz","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js"></script><meta name="description" content="Android与车载OBD设备的连接、通信"><meta property="og:type" content="article"><meta property="og:title" content="Android-OBD开发"><meta property="og:url" content="https://blog.xxin.xyz/2023/01/10/Android-OBD%E5%BC%80%E5%8F%91/index.html"><meta property="og:site_name" content="小信笔记"><meta property="og:description" content="Android与车载OBD设备的连接、通信"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://img.xxin.xyz/img/admin/2023/01/12/h3otzt.jpg"><meta property="og:image" content="https://img.xxin.xyz/img/admin/2023/01/12/h49hfd.jpg"><meta property="article:published_time" content="2023-01-10T06:53:06.000Z"><meta property="article:modified_time" content="2023-05-16T11:29:01.577Z"><meta property="article:author" content="xxin"><meta property="article:tag" content="Android开发手记"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://img.xxin.xyz/img/admin/2023/01/12/h3otzt.jpg"><link rel="canonical" href="https://blog.xxin.xyz/2023/01/10/Android-OBD%E5%BC%80%E5%8F%91/"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.xxin.xyz/2023/01/10/Android-OBD%E5%BC%80%E5%8F%91/","path":"2023/01/10/Android-OBD开发/","title":"Android-OBD开发"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Android-OBD开发 | 小信笔记</title><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">小信笔记</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">逃避思考，热爱幻想</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="搜索" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#OBD%E8%AE%BE%E5%A4%87"><span class="nav-number">1.</span> <span class="nav-text">OBD设备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%B3%E8%AF%B7%E6%9D%83%E9%99%90"><span class="nav-number">2.</span> <span class="nav-text">申请权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93%E5%BC%80%E8%93%9D%E7%89%99"><span class="nav-number">3.</span> <span class="nav-text">打开蓝牙</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%AB%E6%8F%8F%E8%93%9D%E7%89%99"><span class="nav-number">4.</span> <span class="nav-text">扫描蓝牙</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E5%AF%B9%E8%93%9D%E7%89%99"><span class="nav-number">5.</span> <span class="nav-text">配对蓝牙</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E8%93%9D%E7%89%99"><span class="nav-number">6.</span> <span class="nav-text">连接蓝牙</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%93%9D%E7%89%99%E9%80%9A%E4%BF%A1"><span class="nav-number">7.</span> <span class="nav-text">蓝牙通信</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E6%96%B9%E6%B3%95"><span class="nav-number">8.</span> <span class="nav-text">其他方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="nav-number">9.</span> <span class="nav-text">使用方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%88%E6%9E%9C%E9%A2%84%E8%A7%88"><span class="nav-number">10.</span> <span class="nav-text">效果预览</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="xxin" src="https://q1.qlogo.cn/g?b=qq&nk=3033528136&s=640"><p class="site-author-name" itemprop="name">xxin</p><div class="site-description" itemprop="description">路漫漫其修远兮，吾将上下而求索。</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">189</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">22</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/xxinPro" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xxinPro" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://wpa.qq.com/msgrd?v=3&uin=3033528136&site=qq&menu=yes" title="QQ → https:&#x2F;&#x2F;wpa.qq.com&#x2F;msgrd?v&#x3D;3&amp;uin&#x3D;3033528136&amp;site&#x3D;qq&amp;menu&#x3D;yes" rel="noopener me" target="_blank"><i class="fab fa-qq fa-fw"></i>QQ</a> </span><span class="links-of-author-item"><a href="mailto:x@xxin.xyz" title="E-Mail → mailto:x@xxin.xyz" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a></span></div></div></div></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.xxin.xyz/2023/01/10/Android-OBD%E5%BC%80%E5%8F%91/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://q1.qlogo.cn/g?b=qq&nk=3033528136&s=640"><meta itemprop="name" content="xxin"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="小信笔记"><meta itemprop="description" content="路漫漫其修远兮，吾将上下而求索。"></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="Android-OBD开发 | 小信笔记"><meta itemprop="description" content="<center>Android与车载OBD设备的连接、通信</center>"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Android-OBD开发</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-01-10 14:53:06" itemprop="dateCreated datePublished" datetime="2023-01-10T14:53:06+08:00">2023-01-10</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a> </span></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>17k</span></span></div><div class="post-description"><center>Android与车载OBD设备的连接、通信</center></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="OBD设备"><a href="#OBD设备" class="headerlink" title="OBD设备"></a>OBD设备</h2><p>&ensp;&ensp;在此之前，从未接触OBD这个东西，蓝牙也少有接触，谨以此篇来记录一下与OBD设备通信的开发过程</p><h2 id="申请权限"><a href="#申请权限" class="headerlink" title="申请权限"></a>申请权限</h2><p>&ensp;&ensp;首先在清单文件中添加蓝牙权限<br></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 使用蓝牙 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.BLUETOOTH&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 蓝牙管理 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.BLUETOOTH_ADMIN&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p></p><h2 id="打开蓝牙"><a href="#打开蓝牙" class="headerlink" title="打开蓝牙"></a>打开蓝牙</h2><p>&ensp;&ensp;创建一个<code>OBDManager</code>类，添加一个<code>getInstance()</code>方法，使用单例模式获取当前类的实例<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OBDManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> OBDManager obdManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 禁止创建对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">OBDManager</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过单例模式获取该类的实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> OBDManager <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (obdManager == <span class="literal">null</span>) &#123;</span><br><span class="line">            obdManager = <span class="keyword">new</span> <span class="title class_">OBDManager</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> obdManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>&ensp;&ensp;添加一个<code>init()</code>方法，为该类提供简单的初始化<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> BluetoothAdapter bluetoothAdapter;  <span class="comment">// 蓝牙适配器</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化蓝牙适配器</span></span><br><span class="line">    bluetoothAdapter = BluetoothAdapter.getDefaultAdapter();</span><br><span class="line">    <span class="comment">// 还有另外一种获取蓝牙适配器的方法，不过比较麻烦</span></span><br><span class="line">    <span class="comment">//BluetoothManager bluetoothManager = (BluetoothManager) context.getSystemService(Context.BLUETOOTH_SERVICE);</span></span><br><span class="line">    <span class="comment">//bluetoothAdapter = bluetoothManager.getAdapter();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>&ensp;&ensp;判断设备是否拥有蓝牙功能，Android模拟器是提供不了蓝牙功能的<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断设备是否拥有蓝牙功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isHasBluetooth</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (bluetoothAdapter != <span class="literal">null</span> &amp;&amp; context.getPackageManager().hasSystemFeature(PackageManager.FEATURE_BLUETOOTH));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>&ensp;&ensp;判断当前是否已经打开蓝牙，打开\关闭蓝牙<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断当前是否已经打开蓝牙</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnableBluetooth</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> bluetoothAdapter.isEnabled();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 打开蓝牙，不需要手动操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">enableBluetooth</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> bluetoothAdapter.enable();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 打开蓝牙，需要手动确定</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">enableBluetooth</span><span class="params">(Activity activity)</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(BluetoothAdapter.ACTION_REQUEST_ENABLE);</span><br><span class="line">    activity.startActivityForResult(intent, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 关闭蓝牙，不需要手动操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">disableBluetooth</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> bluetoothAdapter.disable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="扫描蓝牙"><a href="#扫描蓝牙" class="headerlink" title="扫描蓝牙"></a>扫描蓝牙</h2><p>&ensp;&ensp;在真正开始搜索蓝牙设备之前，需要先注册一个广播，在广播中接收系统搜索到的蓝牙设备，并统一添加到一个集合中，然后添加一个回调事件，用以再扫描到设备时调用<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注册接收蓝牙搜索结果的广播</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="type">IntentFilter</span> <span class="variable">intentFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntentFilter</span>();</span><br><span class="line">    intentFilter.addAction(BluetoothDevice.ACTION_FOUND);               <span class="comment">// 接受搜索到蓝牙设备的广播</span></span><br><span class="line">    intentFilter.addAction(BluetoothDevice.ACTION_BOND_STATE_CHANGED);  <span class="comment">// 接受配对状态改变时的广播</span></span><br><span class="line">    context.registerReceiver(bluetoothReceiver, intentFilter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注销接收蓝牙搜索结果的广播</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unregister</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    context.unregisterReceiver(bluetoothReceiver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 储存搜索到的附近的蓝牙设备</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;BluetoothDevice&gt; bluetoothDeviceList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取搜索到的蓝牙设备</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> List&lt;BluetoothDevice&gt; <span class="title function_">getBluetoothDeviceList</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> bluetoothDeviceList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 清空已经搜索到的所有蓝牙设备</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clearBluetoothDeviceList</span><span class="params">()</span> &#123;</span><br><span class="line">    bluetoothDeviceList.clear();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 接收蓝牙搜索结果的广播，配对结果的广播</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">BroadcastReceiver</span> <span class="variable">bluetoothReceiver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BroadcastReceiver</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReceive</span><span class="params">(Context context, Intent intent)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">action</span> <span class="operator">=</span> intent.getAction();</span><br><span class="line">        <span class="keyword">if</span> (action != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (action.equals(BluetoothDevice.ACTION_FOUND)) &#123;</span><br><span class="line">                <span class="type">BluetoothDevice</span> <span class="variable">device</span> <span class="operator">=</span> intent.getParcelableExtra(BluetoothDevice.EXTRA_DEVICE);</span><br><span class="line">                <span class="comment">// 如果搜索到的设备不存在于集合中，那么添加到集合，屏蔽没有名称或者地址的蓝牙设备</span></span><br><span class="line">                <span class="keyword">if</span> (device.getName() != <span class="literal">null</span> &amp;&amp; device.getAddress() != <span class="literal">null</span> &amp;&amp; !isExistDevice(device)) &#123;</span><br><span class="line">                    bluetoothDeviceList.add(device);</span><br><span class="line">                    <span class="comment">// 扫描到设备时的回调</span></span><br><span class="line">                    <span class="keyword">if</span> (onScanBluetoothDeviceListener != <span class="literal">null</span>) &#123;</span><br><span class="line">                        onScanBluetoothDeviceListener.OnScan(device);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(BluetoothDevice.ACTION_BOND_STATE_CHANGED)) &#123;</span><br><span class="line">                <span class="comment">// 当前配对状态</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">state</span> <span class="operator">=</span> intent.getIntExtra(BluetoothDevice.EXTRA_BOND_STATE,BluetoothDevice.ERROR);</span><br><span class="line">                <span class="comment">// 上个配对状态</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">prevState</span> <span class="operator">=</span> intent.getIntExtra(BluetoothDevice.EXTRA_PREVIOUS_BOND_STATE,BluetoothDeviceERROR);</span><br><span class="line">                <span class="comment">// 刚刚正在配对，现在配对成功，说明配对成功</span></span><br><span class="line">                <span class="keyword">if</span> (state == BluetoothDevice.BOND_BONDED &amp;&amp; prevState == BluetoothDevice.BOND_BONDING) &#123;</span><br><span class="line">                    <span class="comment">// 配对成功</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 刚刚没有配对，现在正在配对，说明开始配对</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (state == BluetoothDevice.BOND_BONDING &amp;&amp; prevState == BluetoothDevice.BOND_NONE) &#123;</span><br><span class="line">                    <span class="comment">// 开始配对</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 这个直接就说明配对失败</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (state == BluetoothDevice.BOND_NONE) &#123;</span><br><span class="line">                    <span class="comment">// 配对失败</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果集合中是否存在这个目标设备</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> newDevice 目标设备</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isExistDevice</span><span class="params">(BluetoothDevice newDevice)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (BluetoothDevice bluetoothDevice : bluetoothDeviceList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bluetoothDevice.getAddress().equals(newDevice.getAddress())) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描到设备时的回调</span></span><br><span class="line"><span class="keyword">private</span> OnScanBluetoothDeviceListener onScanBluetoothDeviceListener;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扫描到设备时的回调</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OnScanBluetoothDeviceListener</span>&#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">OnScan</span><span class="params">(BluetoothDevice bluetoothDevice)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>&ensp;&ensp;开始搜索蓝牙设备，停止搜索蓝牙设备，在开始搜索蓝牙设备的方法中传入回调方法，用以在搜索到蓝牙设备时调用<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 开始搜索附近蓝牙设备</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">startScanBluetoothDevices</span><span class="params">(OnScanBluetoothDeviceListener onScanBluetoothDeviceListener)</span> &#123;</span><br><span class="line">    <span class="comment">// 如果蓝牙没启用，则启用蓝牙</span></span><br><span class="line">    <span class="keyword">if</span> (!isEnableBluetooth()) &#123;</span><br><span class="line">        enableBluetooth();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.onScanBluetoothDeviceListener = onScanBluetoothDeviceListener;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开始搜索附近设备</span></span><br><span class="line">    bluetoothAdapter.startDiscovery();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 停止搜索附近蓝牙设备</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancelScanBluetoothDevices</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 如果蓝牙没有启动，就不用继续向下执行了</span></span><br><span class="line">    <span class="keyword">if</span> (!isEnableBluetooth()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    bluetoothAdapter.cancelDiscovery();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="配对蓝牙"><a href="#配对蓝牙" class="headerlink" title="配对蓝牙"></a>配对蓝牙</h2><p>&ensp;&ensp;调用<code>setPin()</code>方法使系统自动输入配对码，免去用户手动输入的繁琐，调用<code>setPairingConfirmation()</code>方法设置是否确认当前的配对，免去用户手动点击确认配对，调用<code>createBond()</code>即开始进行蓝牙配对<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送配对请求，进行蓝牙配对</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bluetoothDevice 目标设备</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 配对请求发送结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">createBond</span><span class="params">(BluetoothDevice bluetoothDevice)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</span><br><span class="line">        <span class="keyword">return</span> bluetoothDevice.createBond();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> bluetoothDevice.getClass().getMethod(<span class="string">&quot;createBond&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">boolean</span>) method.invoke(bluetoothDevice);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置为确认配对状态，可以不经过用户操作自动配对蓝牙设备，这个权限无法授权给三方应用</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bluetoothDevice 目标设备</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> confirm 是否为确认状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">setPairingConfirmation</span><span class="params">(BluetoothDevice bluetoothDevice, <span class="type">boolean</span> confirm)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</span><br><span class="line">        <span class="keyword">return</span> bluetoothDevice.setPairingConfirmation(confirm);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> bluetoothDevice.getClass().getMethod(<span class="string">&quot;setPairingConfirmation&quot;</span>, <span class="type">boolean</span>.class);</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">boolean</span>) method.invoke(bluetoothDevice, confirm);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 设置配对码</span></span><br><span class="line"><span class="comment"> * @param bluetoothDevice 目标设备</span></span><br><span class="line"><span class="comment"> * @param pin 配对码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">setPin</span><span class="params">(BluetoothDevice bluetoothDevice, <span class="type">byte</span>[] pin)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123;</span><br><span class="line">        <span class="keyword">return</span> bluetoothDevice.setPin(pin);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> bluetoothDevice.getClass().getMethod(<span class="string">&quot;setPin&quot;</span>, <span class="type">byte</span>[].class);</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">boolean</span>)method.invoke(bluetoothDevice, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;pin&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>&ensp;&ensp;然后写一个bondDevice()方法来调用这三个方法，注意调用顺序：<code>setPin()</code>、<code>setPairingConfirmation()</code>、<code>createBond()</code>，这里需要注意的是，我所开发的软件是一个拥有所有权限的系统软件，所以可以不经过用户操作自动配对蓝牙设备，正常的三方软件开发过程中，<code>setPairingConfirmation()</code>会发生异常，在删除该方法的调用后，系统会显示一个允许配对的对话框<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配对蓝牙设备</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bluetoothDevice 目标蓝牙设备</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pinCode 配对所使用的pin码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">bondDevice</span><span class="params">(BluetoothDevice bluetoothDevice, String pinCode)</span> &#123;</span><br><span class="line">    <span class="comment">// 配对码不为空时设置配对码</span></span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(pinCode)) &#123;</span><br><span class="line">        setPin(bluetoothDevice, pinCode.getBytes());<span class="comment">// 设置pin码</span></span><br><span class="line">    &#125;</span><br><span class="line">    setPairingConfirmation(bluetoothDevice, <span class="literal">true</span>);  <span class="comment">// 设置为确认配对状态</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">bond</span> <span class="operator">=</span> createBond(bluetoothDevice);     <span class="comment">// 进行配对</span></span><br><span class="line">    <span class="keyword">if</span> (bond) &#123;</span><br><span class="line">        <span class="comment">// 配对请求发送成功</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 配对请求发送失败</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 目标蓝牙设备是否已经配对</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bluetoothDevice 目标设备</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isBondDevice</span><span class="params">(BluetoothDevice bluetoothDevice)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> bluetoothDevice.getBondState() == BluetoothDevice.BOND_BONDED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="连接蓝牙"><a href="#连接蓝牙" class="headerlink" title="连接蓝牙"></a>连接蓝牙</h2><p>&ensp;&ensp;经典蓝牙的连接相当于在两个设备之间建立了socket连接，是个耗时操作，所以需要在子线程中执行<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 经典蓝牙的连接相当于socket连接，是个耗时操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ConnectThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BluetoothSocket bluetoothSocket;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConnectThread</span><span class="params">(BluetoothSocket socket)</span> &#123;</span><br><span class="line">        bluetoothSocket = socket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.run();</span><br><span class="line">        <span class="comment">// 进行蓝牙socket连接时先取消搜索蓝牙设备</span></span><br><span class="line">        cancelScanBluetoothDevices();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 建立蓝牙socket连接</span></span><br><span class="line">            bluetoothSocket.connect();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="comment">// 连接失败，关闭socket连接</span></span><br><span class="line">            closeConnect();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭socket连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">closeConnect</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (bluetoothSocket != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bluetoothSocket.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>&ensp;&ensp;使用一个<code>connectToDevice()</code>方法连接设备，传入的<code>bluetoothDevice</code>所代表的设备一定要已经成功配对，注意这里用到的UUID，它是一个预定的建立与OBD之间的连接所需的UUID，另外注意我们要使用createRfcommSocketToServiceRecord将本机作为一个客户端建立与OBD之间的连接，因为OBD是一种蓝牙设备，是一个服务器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// OBD通常默认会使用这个UUID</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">UUID</span> <span class="variable">uuid_obd</span> <span class="operator">=</span> UUID.fromString(<span class="string">&quot;00001101-0000-1000-8000-00805F9B34FB&quot;</span>);</span><br><span class="line"><span class="keyword">private</span> ConnectThread connectThread;    <span class="comment">// 建立Socket连接的进程</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 连接到蓝牙设备</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bluetoothDevice 目标设备</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">connectToDevice</span><span class="params">(BluetoothDevice bluetoothDevice)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 创建与蓝牙设备之间通信的socket通道</span></span><br><span class="line">        <span class="type">BluetoothSocket</span> <span class="variable">socket</span> <span class="operator">=</span> bluetoothDevice.createRfcommSocketToServiceRecord(uuid_obd);</span><br><span class="line">        <span class="comment">// 关闭上个连接进程</span></span><br><span class="line">        <span class="keyword">if</span> (connectThread != <span class="literal">null</span>) &#123;</span><br><span class="line">            connectThread.closeConnect();</span><br><span class="line">            connectThread = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 开启一个socket连接进程，建立与蓝牙设备之间的socket连接</span></span><br><span class="line">        connectThread = <span class="keyword">new</span> <span class="title class_">ConnectThread</span>(socket);</span><br><span class="line">        connectThread.start();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="蓝牙通信"><a href="#蓝牙通信" class="headerlink" title="蓝牙通信"></a>蓝牙通信</h2><p>&ensp;&ensp;创建一个<code>MessageThread</code>类，在这个类中完成两个蓝牙设备之间的通信<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> MessageThread messageThread;    <span class="comment">// 接收\发送消息的进程</span></span><br><span class="line"><span class="keyword">private</span> String message;                 <span class="comment">// 蓝牙设备发送来的消息</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 该线程负责两个蓝牙设备之间的通信</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">MessageThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InputStream inputStream;      <span class="comment">// 接收消息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OutputStream outputStream;    <span class="comment">// 发送消息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isReceiveMsg</span> <span class="operator">=</span> <span class="literal">false</span>;       <span class="comment">// 是否持续接收消息</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MessageThread</span> <span class="params">(BluetoothSocket socket)</span> &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">_input</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">_output</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            _input = socket.getInputStream();</span><br><span class="line">            _output = socket.getOutputStream();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        inputStream = _input;</span><br><span class="line">        outputStream = _output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.run();</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>]; <span class="comment">// 用于缓存数据的缓冲区</span></span><br><span class="line">        <span class="type">int</span> numBytes;                   <span class="comment">// 缓冲区中的字节数</span></span><br><span class="line">        isReceiveMsg = <span class="literal">true</span>;            <span class="comment">// 开始接收消息</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 循环读取数据</span></span><br><span class="line">        <span class="keyword">while</span> (isReceiveMsg) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                numBytes = inputStream.read(buffer);</span><br><span class="line">                <span class="keyword">if</span> (numBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    message = <span class="keyword">new</span> <span class="title class_">String</span>(buffer, <span class="number">0</span>, numBytes);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭消息通道</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">closeMessage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 不再接收消息</span></span><br><span class="line">        isReceiveMsg = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// 中断该线程</span></span><br><span class="line">        <span class="built_in">this</span>.interrupt();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (inputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                inputStream.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (outputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                outputStream.flush();</span><br><span class="line">                outputStream.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息给蓝牙设备</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes 消息字节流</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            outputStream.write(bytes);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>&ensp;&ensp;在添加直接写入和读取消息的方法，方便外部调用<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取蓝牙设备发送的消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">_message</span> <span class="operator">=</span> message;</span><br><span class="line">    message = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">return</span> _message;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 向蓝牙设备发送消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">    sendMessage(msg.getBytes());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 向蓝牙设备发送消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (messageThread != <span class="literal">null</span>) &#123;</span><br><span class="line">        messageThread.write(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>&ensp;&ensp;这样的话，在上面的建立蓝牙连接之后，就可以通过创建MessageThread对象来开启发送和接收消息，如下<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 经典蓝牙的连接相当于socket连接，是个耗时操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ConnectThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BluetoothSocket bluetoothSocket;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConnectThread</span><span class="params">(BluetoothSocket socket)</span> &#123;</span><br><span class="line">        bluetoothSocket = socket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.run();</span><br><span class="line">        <span class="comment">// 连接前先取消搜索蓝牙设备</span></span><br><span class="line">        cancelScanBluetoothDevices();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 建立连接</span></span><br><span class="line">            bluetoothSocket.connect();</span><br><span class="line">            <span class="comment">// 建立通信连接</span></span><br><span class="line">            messageThread = <span class="keyword">new</span> <span class="title class_">MessageThread</span>(bluetoothSocket);</span><br><span class="line">            messageThread.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="comment">// 连接失败，关闭连接</span></span><br><span class="line">            closeConnect();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭socket连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">closeConnect</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (bluetoothSocket != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bluetoothSocket.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (messageThread != <span class="literal">null</span>) &#123;</span><br><span class="line">            messageThread.closeMessage();</span><br><span class="line">            messageThread = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h2><p>&ensp;&ensp;其他经常用到的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取所有已经配对的蓝牙设备的列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> List&lt;BluetoothDevice&gt; <span class="title function_">getBluetoothBondList</span><span class="params">()</span> &#123;</span><br><span class="line">    Set&lt;BluetoothDevice&gt; bondedDevices = bluetoothAdapter.getBondedDevices();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(bondedDevices);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过MAC地址获取一个蓝牙设备</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> address MAC地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 蓝牙设备</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> BluetoothDevice <span class="title function_">getDeviceByAddress</span><span class="params">(String address)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> bluetoothAdapter.getRemoteDevice(address);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&ensp;&ensp;添加一个<code>over()</code>方法，用来结束一切<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 结束所有</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">over</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">    <span class="comment">// 停止扫描设备</span></span><br><span class="line">    cancelScanBluetoothDevices();</span><br><span class="line">    <span class="comment">// 注销通知</span></span><br><span class="line">    unregister(context);</span><br><span class="line">    <span class="comment">// 清除已经扫描到的所有设备</span></span><br><span class="line">    clearBluetoothDeviceList();</span><br><span class="line">    <span class="comment">// 清除扫描回调方法</span></span><br><span class="line">    <span class="keyword">if</span> (onScanBluetoothDeviceListener != <span class="literal">null</span>) &#123;</span><br><span class="line">        onScanBluetoothDeviceListener = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 结束socket连接和通信</span></span><br><span class="line">    <span class="keyword">if</span> (connectThread != <span class="literal">null</span>) &#123;</span><br><span class="line">        connectThread.closeConnect();</span><br><span class="line">        connectThread = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><p>&ensp;&ensp;在<code>onCreate()</code>方法中，先注册接收蓝牙的通知</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OBDManager.getInstance().register(<span class="built_in">this</span>);</span><br></pre></td></tr></table></figure><p>&ensp;&ensp;在<code>onResume()</code>方法中，使用<code>initBlue()</code>方法初始化蓝牙</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化蓝牙</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initBlue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">OBDManager</span> <span class="variable">obdManager</span> <span class="operator">=</span> OBDManager.getInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断设备是否支持蓝牙功能</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">hasBluetooth</span> <span class="operator">=</span> obdManager.isHasBluetooth(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (hasBluetooth) &#123;</span><br><span class="line">        <span class="comment">// 判断蓝牙是否启用</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isEnableBluetooth</span> <span class="operator">=</span> obdManager.isEnableBluetooth();</span><br><span class="line">        <span class="keyword">if</span> (isEnableBluetooth) &#123;</span><br><span class="line">            <span class="comment">// 蓝牙已启用，初始化蓝牙列表</span></span><br><span class="line">            initList();</span><br><span class="line">            <span class="comment">// 开始搜索蓝牙设备</span></span><br><span class="line">            obdManager.startScanBluetoothDevices(bluetoothDevice -&gt; &#123;</span><br><span class="line">                <span class="comment">// 搜索到蓝牙设备之后的回调</span></span><br><span class="line">                initList();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;    <span class="comment">// 如果蓝牙未启用，则在此启用蓝牙，并使用handle在启用一秒后递归</span></span><br><span class="line">            <span class="comment">// 正在启用蓝牙</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">enableBluetooth</span> <span class="operator">=</span> obdManager.enableBluetooth();</span><br><span class="line">            <span class="comment">// 启用成功后等待一秒递归</span></span><br><span class="line">            <span class="keyword">if</span> (enableBluetooth) &#123;</span><br><span class="line">                <span class="comment">// 此处是lambda表达式</span></span><br><span class="line">                handler.postDelayed(<span class="built_in">this</span>::initBlue, <span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 蓝牙启用失败</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 设备不支持蓝牙功能</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&ensp;&ensp;<code>initBlue()</code>中调用了<code>initList()</code>使搜索到的附近蓝牙设备在列表中显示，点击列表item时判断这个item所代表的蓝牙设备是否配对，如果已经配对则建立通信连接，如果没有配对则显示一个输入配对码的弹窗，输入配对码后点击确定进行配对，这里注意一下，OBD设备的配对码一般是“1234”或者“0000”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">RecyclerView</span> <span class="variable">blue_list</span> <span class="operator">=</span> findViewById(R.id.blue_list); <span class="comment">// 蓝牙列表</span></span><br><span class="line"><span class="keyword">private</span> BlueAdapter blueAdapter;    <span class="comment">// RecyclerView适配器</span></span><br><span class="line"><span class="keyword">private</span> DialogX dialogX;            <span class="comment">// 弹窗工具</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化蓝牙列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initList</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">OBDManager</span> <span class="variable">obdManager</span> <span class="operator">=</span> OBDManager.getInstance();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (blueAdapter != <span class="literal">null</span>) &#123;</span><br><span class="line">        blueAdapter.setData(obdManager.getBluetoothDeviceList());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        blueAdapter = <span class="keyword">new</span> <span class="title class_">BlueAdapter</span>(<span class="built_in">this</span>, obdManager.getBluetoothDeviceList());</span><br><span class="line">        <span class="type">LinearLayoutManager</span> <span class="variable">layoutManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinearLayoutManager</span>(<span class="built_in">this</span>, RecyclerView.VERTICAL, <span class="literal">false</span>);</span><br><span class="line">        blue_list.setAdapter(blueAdapter);</span><br><span class="line">        blue_list.setLayoutManager(layoutManager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里是自建的RecyclerView的itemClick</span></span><br><span class="line">        blueAdapter.setOnRecyclerItemClick((position, bluetoothDevice) -&gt; &#123;</span><br><span class="line">            <span class="comment">// 如果已经配对</span></span><br><span class="line">            <span class="keyword">if</span> (obdManager.isBondDevice(bluetoothDevice)) &#123;</span><br><span class="line">                <span class="comment">// 连接蓝牙设备</span></span><br><span class="line">                obdManager.connectToDevice(bluetoothDevice);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 显示一个带有编辑框和两个按钮的输入框</span></span><br><span class="line">                dialogX = DialogXUtil.showEditTwoButtonDialog(<span class="built_in">this</span>, <span class="string">&quot;请输入配对码&quot;</span>, <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;配对码&quot;</span>, <span class="string">&quot;确定&quot;</span>, <span class="string">&quot;取消&quot;</span>, InputType.TYPE_CLASS_TEXT, <span class="literal">true</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">DialogXUtil</span>.OnEditDialogOnSureButtonClick() &#123;   <span class="comment">// 点击确定按钮的事件</span></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">ClickListener</span><span class="params">(EditText dialog_edit)</span> &#123;</span><br><span class="line">                                dialogX.dismiss();</span><br><span class="line">                                <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> dialog_edit.getText().toString();</span><br><span class="line">                                <span class="comment">// 配对设备</span></span><br><span class="line">                                obdManager.bondDevice(bluetoothDevice, string);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, <span class="keyword">new</span> <span class="title class_">DialogXUtil</span>.OnEditDialogOnCancelButtonClick() &#123;  <span class="comment">// 点击取消按钮的事件</span></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">ClickListener</span><span class="params">(EditText dialog_edit)</span> &#123;</span><br><span class="line">                                dialogX.dismiss();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&ensp;&ensp;再添加几个按钮，调用其他方法<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 打开蓝牙</span></span><br><span class="line">open_blue.setOnClickListener(view -&gt; &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">enableBluetooth</span> <span class="operator">=</span> OBDManager.getInstance().enableBluetooth();</span><br><span class="line">    <span class="keyword">if</span> (enableBluetooth) &#123;</span><br><span class="line">        TickApplication.getInstance().speak(<span class="string">&quot;蓝牙启用成功&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        TickApplication.getInstance().speak(<span class="string">&quot;蓝牙启用失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭蓝牙</span></span><br><span class="line">close_blue.setOnClickListener(view -&gt; &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">disableBluetooth</span> <span class="operator">=</span> OBDManager.getInstance().disableBluetooth();</span><br><span class="line">    <span class="keyword">if</span> (disableBluetooth) &#123;</span><br><span class="line">        TickApplication.getInstance().speak(<span class="string">&quot;蓝牙关闭成功&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        TickApplication.getInstance().speak(<span class="string">&quot;蓝牙关闭失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 刷新蓝牙列表</span></span><br><span class="line">notify_blue.setOnClickListener(view -&gt; &#123;</span><br><span class="line">    <span class="type">OBDManager</span> <span class="variable">obdManager</span> <span class="operator">=</span> OBDManager.getInstance();</span><br><span class="line">    <span class="comment">// 结束</span></span><br><span class="line">    obdManager.over(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// 注册通知</span></span><br><span class="line">    obdManager.register(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// 重新初始化</span></span><br><span class="line">    initBlue();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p></p><p>&ensp;&ensp;最后，在<code>onDestory()</code>方法中调用<code>OBDManager</code>类下的<code>over()</code>方法结束一切<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OBDManager.getInstance().over(<span class="built_in">this</span>);</span><br></pre></td></tr></table></figure><p></p><h2 id="效果预览"><a href="#效果预览" class="headerlink" title="效果预览"></a>效果预览</h2><p>&ensp;&ensp;列表中第三个那一堆东西是我在验证某个蓝牙设备已经匹配之后，显示它的所有UUID，打开设置是跳转到系统设置，缺点是没有在界面中添加通信功能，代码里都有<br><img src="https://img.xxin.xyz/img/admin/2023/01/12/h3otzt.jpg" width="70%" height="70%"><br><img src="https://img.xxin.xyz/img/admin/2023/01/12/h49hfd.jpg" width="70%" height="70%"></p></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Android%E5%BC%80%E5%8F%91%E6%89%8B%E8%AE%B0/" rel="tag"><i class="fa fa-tag"></i> Android开发手记</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2022/12/27/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" rel="prev" title="正则表达式"><i class="fa fa-angle-left"></i> 正则表达式</a></div><div class="post-nav-item"><a href="/2023/02/14/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1%E5%B0%8F%E7%B1%B3%E5%88%B7%E6%9C%BA/" rel="next" title="记录一次小米刷机">记录一次小米刷机 <i class="fa fa-angle-right"></i></a></div></div></footer></article></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鲁ICP备19064654号-5</a></div><div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">xxin</span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://lib.baomitu.com/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://lib.baomitu.com/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="https://lib.baomitu.com/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script src="/js/third-party/fancybox.js"></script><script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script><script src="/js/third-party/math/mathjax.js"></script></body></html>